package osmdiff

import org.apache.log4j.{Level, Logger}
import org.apache.spark._
import org.apache.spark.rdd._
import org.apache.spark.sql.expressions.Window
import org.apache.spark.sql.functions._

import org.openstreetmap.osmosis.xml.common.CompressionMethod
import org.openstreetmap.osmosis.xml.v0_6.XmlChangeReader

import scala.collection.mutable

import java.io.File


object AugmentedDiff {

  val spark = Common.sparkSession("Augmented Diff")
  import spark.implicits._

  val window1 = Window.partitionBy("way_id").orderBy(desc("instant"))
  val window2 = Window.partitionBy("relation_id").orderBy(desc("instant"))

  def recurseNodes(nodeIds: List[Long]) = {

    var keepGoing = true

    val nodes = mutable.Set.empty[(Long, Long)]
    val ways = mutable.Set.empty[(Long, Long)]
    val relations = mutable.Set.empty[(Long, Long)]

    nodes ++= nodeIds.map({ id => (id, Long.MaxValue) })
    ways ++= {
      val _ways = spark.table("node_to_ways").union(spark.table("node_to_ways_updates"))
        .filter(col("id").isin(nodeIds:_*))
        .withColumn("row_number", row_number().over(window1))
        .filter(col("row_number") === 1) // XXX only works for "now"
        .select(col("way_id"), col("instant"))
        .map({ row => (row.getAs[Long]("way_id"), row.getAs[Long]("instant")) })
        .collect
      _ways
    }
    relations ++= {
      val _relations = spark.table("node_to_relations").union(spark.table("node_to_relations_updates"))
        .filter(col("id").isin(nodeIds:_*))
        .withColumn("row_number", row_number().over(window2))
        .filter(col("row_number") === 1) // XXX
        .select(col("relation_id"), col("instant"))
        .map({ row => (row.getAs[Long]("way_id"), row.getAs[Long]("instant")) })
        .collect
      _relations
    }

    (ways, relations)
  }

  val moop1: List[List[Long]] = List(
    List(4040837174L, 4040837176L, 4040837181L, 4040837184L, 4040837197L, 4040837201L, 4040837203L, 4040837216L, 4040837223L, 4040837237L, 4040837246L, 4040837249L, 4040837253L, 4040837264L, 4040837277L, 4040837290L),
    List(4040837291L, 4040837310L, 4040837311L, 4042792611L, 4042792616L, 4042792621L, 4042792623L, 4042794119L, 4042796777L, 4042796784L, 4042797301L, 4042797302L, 4042798430L, 4042798439L, 4042798446L, 4042798465L),
    List(4042798639L, 4042799705L, 4042802439L, 4042821429L, 4042821430L, 4042822420L, 4042823246L, 4042827749L, 4042827753L, 4042829295L, 4042829303L, 4042829304L, 4042829306L, 4042829307L, 4042829322L, 4042829328L),
    List(4042829332L, 4042835560L, 4042836428L, 4042836435L, 4042836436L, 4042836438L, 4042847621L, 4042847622L, 4042847627L, 4042847629L, 4042847640L, 4042847645L, 4042847657L, 4042847670L, 4042847676L, 4042847677L),
    List(4042847679L, 4042847683L, 4042847684L, 4042847687L, 4042847701L, 4042847713L, 4042847731L, 4042847734L, 4042848732L, 4042848733L, 4042848738L, 4042848746L, 4042848751L, 4042848753L, 4042848760L, 4042849804L),
    List(4042849813L, 4042849816L, 4042849819L, 4042852409L, 4042854376L, 4042854377L, 4042855681L, 4042855686L, 4042855688L, 4042856194L, 4042856196L, 4042856566L, 4042856576L, 4042856622L, 4042856997L, 4042857700L),
    List(4042857703L, 4042857709L, 4042857711L, 4042857712L, 4042857714L, 4042858822L, 4042858826L, 4042858828L, 4042859350L, 4042859359L, 4042859365L, 4042859367L, 4042859370L, 4042859376L, 4042866090L, 4042866091L),
    List(4042866095L, 4042866108L, 4042866116L, 4042866124L, 4042871539L, 4042871541L, 4042871545L, 4042871550L, 4042871552L, 4042871557L, 4042885002L, 4042885007L, 4042885008L, 4042885026L, 4042885054L, 4042885058L),
    List(4042888264L, 4042888267L, 4042888268L, 4042888275L, 4042888795L, 4042888807L, 4042888817L, 4042888818L, 4042888827L, 4042888858L, 4042888867L, 4042888870L, 4042888882L, 4042888885L, 4042896284L, 4042896287L),
    List(4042888264L, 4042888267L, 4042888268L, 4042888275L, 4042888795L, 4042888807L, 4042888817L, 4042888818L, 4042888827L, 4042888858L, 4042888867L, 4042888870L, 4042888882L, 4042888885L, 4042896284L, 4042896287L),
    List(4042907136L, 4042907138L, 4042907647L, 4042907651L, 4042907665L, 4042907671L, 4042907679L, 4042907682L, 4042907683L, 4042907684L, 4042907687L, 4042907953L, 4042907956L, 4042907959L, 4042907961L, 4042907963L),
    List(4042908874L, 4042908876L, 4042908878L, 4042908884L, 4042908889L, 4042908891L, 4042908897L, 4042908900L, 4042908909L, 4042908916L, 4042908923L, 4042908948L, 4042909084L, 4042909891L, 4042909896L, 4042909910L),
    List(4042909911L, 4042909917L, 4042909922L, 4042909934L, 4042909941L, 4042909944L, 4042913591L, 4042913597L, 4042913600L, 4042913605L, 4042913623L, 4042913635L, 4042913636L, 4042913638L, 4042913648L, 4042913660L),
    List(4042913665L, 4042913666L, 4042913670L, 4042913678L, 4042913684L, 4042913688L, 4042913795L, 4042913798L, 4042914031L, 4042923297L, 4042923305L, 4042923317L, 4042923318L, 4042923327L, 4042924296L, 4042924300L),
    List(4042924320L, 4042924324L, 4042924325L, 4042924332L, 4042924344L, 4042924352L, 4042924370L, 4042924385L, 4042924386L, 4042924397L, 4042924399L, 4042924400L, 4042925799L, 4042925913L, 4042925920L, 4042925947L),
    List(4042927665L, 4042927667L, 4042927669L, 4042927673L, 4042927688L, 4042927793L, 4042927797L, 4042927809L, 4042927815L, 4042927817L, 4042927824L, 4042927826L, 4042927828L, 4042927845L, 4042927859L, 4042927867L),
    List(4042927970L, 4042927971L, 4042927982L, 4042928024L, 4042928027L, 4042928033L, 4042928034L, 4042928042L, 4042928593L, 4042936682L, 4042937290L, 4042937303L, 4042937309L, 4042937315L, 4042937318L, 4042937322L),
    List(4042937336L, 4042937337L, 4042937339L, 4042937341L, 4042937347L, 4042937348L, 4042937357L, 4042937360L, 4042937365L, 4042937372L, 4042937373L, 4042937385L, 4043586026L, 4043586032L, 4043586035L, 4043586040L),
    List(4043586045L, 4043586068L, 4043586078L, 4043586083L, 4043586087L, 4043586194L, 4043586213L, 4043586230L, 4043586235L, 4043586244L, 4043586246L, 4043586250L, 4043586252L, 4043586259L, 4043586261L, 4043586284L),
    List(4043586297L, 4043586302L, 4043586334L, 4043586335L, 4043586336L, 4043586340L, 4043586343L, 4043586354L, 4043586372L, 4043586376L, 4043586396L, 4043586406L, 4043586416L, 4043586420L, 4043586421L, 4043588651L),
    List(4043588660L, 4043588661L, 4043588664L, 4043588667L, 4043588677L, 4043588687L, 4043588688L, 4043591089L, 4043591097L, 4043591107L, 4043591123L, 4043591142L, 4043591155L, 4043591166L, 4043591401L, 4043591412L),
    List(4043591415L, 4043591423L, 4043591444L, 4043591445L, 4043591450L, 4043591461L, 4043591471L, 4043594888L, 4043595095L, 4043595101L, 4043595105L, 4043595106L, 4043595115L, 4043595121L, 4043595142L, 4043595143L),
    List(4043595154L, 4043595166L, 4043595168L, 4043595174L, 4043595177L, 4043595182L, 4043595499L, 4043595502L, 4043595504L, 4043595519L, 4043595522L, 4043595527L, 4043606698L, 4043606699L, 4043606725L, 4043606728L),
    List(4043606729L, 4043606731L, 4043606744L, 4043606755L, 4043606761L, 4043606774L, 4043606778L, 4043606796L, 4043606798L, 4043606801L, 4043606804L, 4043606806L, 4043606809L, 4043606811L, 4043606816L, 4043606824L),
    List(4043606825L, 4043606845L, 4043606869L, 4043606876L, 4043606878L, 4043606880L, 4043606885L, 4043606899L, 4043606912L, 4043606913L, 4043606914L, 4043606917L, 4043606918L, 4043606925L, 4043606931L, 4043606933L),
    List(4043606942L, 4043606964L, 4043606967L, 4043606973L, 4043606985L, 4043606990L, 4043607000L, 4043607016L, 4043607022L, 4043607024L, 4043607027L, 4043607035L, 4043607039L, 4043607861L, 4043607863L, 4043607868L),
    List(4043607872L, 4043607885L, 4043610503L, 4043610510L, 4043610512L, 4043610514L, 4043610516L, 4043610538L, 4043610543L, 4043611944L, 4043611949L, 4043611956L, 4043611961L, 4043611962L, 4043611969L, 4043611974L),
    List(4043611981L, 4043612391L, 4043612393L, 4043612398L, 4043612404L, 4043612406L, 4043612424L, 4043612425L, 4043612427L, 4043612442L, 4043616442L, 4043616460L, 4043616485L, 4043616487L, 4043618495L, 4043618513L),
    List(4043618516L, 4043618520L, 4043618523L, 4043618524L, 4043618525L, 4043618537L, 4043618540L, 4043618543L, 4043618545L, 4043621883L, 4043621994L, 4043621999L, 4043622005L, 4043622007L, 4043622011L, 4043622015L),
    List(4043622018L, 4043622033L, 4043622034L, 4043622046L, 4043622049L, 4043622054L, 4043622055L, 4043622063L, 4043622065L, 4043622069L, 4043622074L, 4043622078L, 4043622093L, 4043622098L, 4043622100L, 4043622102L),
    List(4043622103L, 4043622118L, 4043622120L, 4043622129L, 4043622130L, 4043622133L, 4043622141L, 4043624378L, 4043624994L, 4043624998L, 4043625002L, 4043625021L, 4043625023L, 4043625035L, 4043625043L, 4043625047L),
    List(4043625058L, 4043625956L, 4043625966L, 4043625971L, 4043625985L, 4043636011L, 4043636013L, 4043636022L, 4043637614L, 4043637617L, 4043637618L, 4043652155L, 4043652163L, 4043652168L, 4043652177L, 4043652182L),
    List(4043652192L, 4043652195L, 4043652198L, 4043652211L, 4043652214L, 4046455531L, 4046455537L, 4046455561L, 4046482364L, 4046482375L, 4046482386L, 4046482388L, 4046483390L, 4046483400L, 4046483411L, 4046483418L),
    List(4046483427L, 4046483449L, 4046483456L, 4046483457L, 4046483467L, 4046483487L, 4046483592L, 4046483609L, 4046483792L, 4046483795L, 4046483803L, 4046483805L, 4046483807L, 4046483815L, 4046483827L, 4046483833L),
    List(4046483838L, 4046483841L, 4046483847L, 4046483894L, 4046483897L, 4046483954L, 4046483963L, 4046483971L, 4046483973L, 4046483975L, 4046483980L, 4046484090L, 4048139960L, 4048139969L, 4048139970L, 4048147403L),
    List(4048148259L, 4048151787L, 4048163398L, 4048163400L, 4048182111L, 4048182115L, 4048190457L, 4048237928L, 4048256137L, 4048256138L, 4048256149L, 4048256156L, 4048259774L, 4048326685L, 4048326687L, 4048332083L),
    List(4048332084L, 4048332085L, 4048366495L, 4048366502L, 4048366525L, 4048366532L, 4048366534L, 4048366539L, 4048366542L, 4049189169L, 4049189182L, 4049189512L, 4049190193L, 4049190205L, 4049191334L, 4049191336L),
    List(4049191342L, 4049192558L, 4049192560L, 4049201165L, 4049291198L, 4049291200L, 4049291204L, 4049291218L, 4049291222L, 4049291224L, 4049291232L, 4049291234L, 4049291235L, 4049291254L, 4049313505L, 4049313511L),
    List(4049313512L, 4049313534L, 4049313536L, 4049313544L, 4049313552L, 4049313555L, 4049313558L, 4049313561L, 4049313564L, 4049314066L, 4049314081L, 4049314088L, 4049322260L, 4049322261L, 4049322266L, 4049322280L),
    List(4049322283L, 4049322489L, 4049322494L, 4049322501L, 4050811840L, 4053097824L, 4053097825L, 4053097828L, 4053097830L, 4053097847L, 4053097856L, 4053097866L, 4053097871L, 4053097873L, 4053097876L, 4053097880L),
    List(4053097888L, 4053098913L, 4053098914L, 4053098915L, 4053098917L, 4053098929L, 4053098938L, 4053098939L, 4053098954L, 4053098966L, 4053098967L, 4053098969L, 4053098972L, 4053098974L, 4053098991L, 4053098994L),
    List(4053098995L, 4053099006L, 4053099009L, 4053099037L, 4053099039L, 4053099040L, 4053099043L, 4053099045L, 4053099057L, 4053099061L, 4053099066L, 4053099067L, 4053099068L, 4053099072L, 4053099077L, 4053099080L),
    List(4053099084L, 4053099095L, 4053099106L, 4053099109L, 4053099110L, 4053099126L, 4053099136L, 4053123982L, 4053123983L, 4053123988L, 4053124811L, 4053124823L, 4053124833L, 4053124834L, 4053124840L, 4053124841L),
    List(4053124844L, 4053124873L, 4053124876L, 4053124880L, 4053124991L, 4053124992L, 4053124999L, 4053125001L, 4053125003L, 4053125004L, 4053125005L, 4053125041L, 4053125043L, 4053125056L, 4053125059L, 4053125069L),
    List(4053125076L, 4053133021L, 4053133022L, 4053133059L, 4053133063L, 4053133066L, 4053133087L, 4053133193L, 4053133196L, 4053133202L, 4053133204L, 4053133205L, 4053133212L, 4053133225L, 4053133244L, 4053133248L),
    List(4053934644L, 4053934654L, 4053934655L, 4054047692L, 4054059116L, 4054059124L, 4054059127L, 4054059138L, 4054073457L, 4054073463L, 4054073464L, 4054128167L, 4054603005L, 4054603007L, 4054603008L, 4059009058L),
    List(4059009076L, 4059009088L, 4059010396L, 4059010408L, 4059010413L, 4059010415L, 4059010418L, 4059020384L, 4059025696L, 4059025710L, 4059025722L, 4059025728L, 4059025731L, 4059025741L, 4059025750L, 4059025761L),
    List(4059025762L, 4059029107L, 4059031497L, 4059031501L, 4059031506L, 4059031511L, 4059031519L, 4059031524L, 4059031530L, 4059031554L, 4059031556L, 4059031558L, 4059031575L, 4059035466L, 4059035469L, 4060003368L),
    List(4060055363L, 4060055368L, 4060055371L, 4060055387L, 4060056389L, 4060056397L, 4060056403L, 4060056406L, 4060056407L, 4060056410L, 4060056414L, 4060056416L, 4060056420L, 4060056442L, 4060056447L, 4060056450L),
    List(4060056452L, 4060056463L, 4060056466L, 4060056468L, 4060195251L, 4060215879L, 4060216099L, 4060216103L, 4060247268L, 4060247270L, 4060321831L, 4060321833L, 4060321834L, 4060321837L, 4060321841L, 4060321851L),
    List(4060525920L, 4060525926L, 4060525933L, 4060525949L, 4060525950L, 4060525959L, 4060525961L, 4060525968L, 4060525980L, 4060525984L, 4060527190L, 4060527203L, 4060527205L, 4060527219L, 4060527231L, 4060527236L),
    List(4060527238L, 4060527242L, 4060527245L, 4060527254L, 4060527257L, 4060535966L, 4060536792L, 4060536810L, 4060536816L, 4060536847L, 4060536852L, 4060536854L, 4061884962L, 4061884967L, 4061884969L, 4061884975L),
    List(4061887794L, 4061887797L, 4061887815L, 4061901557L, 4061901559L, 4061901564L, 4061901572L, 4061901582L, 4061901583L, 4061901586L, 4061901595L, 4061901596L, 4061901597L, 4061901630L, 4061901631L, 4061914499L),
    List(4061914500L, 4061914502L, 4062462609L, 4062474452L, 4062474455L, 4062474488L, 4062477690L, 4062488141L, 4062488145L, 4062515102L, 4062515116L, 4062515132L, 4062522387L, 4062524764L, 4062524768L, 4062524774L),
    List(4062524776L, 4062524971L, 4062524982L, 4062524984L, 4062525793L, 4062525795L, 4062525808L, 4062525814L, 4062525832L, 4062525842L, 4062525847L, 4062525849L, 4062525850L, 4062525854L, 4062525859L, 4062525864L),
    List(4062525867L, 4062525870L, 4062525882L, 4062525889L, 4062526365L, 4062526370L, 4062526374L, 4062526377L, 4062526378L, 4062527444L, 4062527446L, 4062528056L, 4062528057L, 4062528058L, 4062893091L, 4062893115L),
    List(4062893132L, 4062893138L, 4062893150L, 4062893156L, 4062893176L, 4062893187L, 4062893190L, 4062893194L, 4062893198L, 4062893201L, 4062893203L, 4062893209L, 4062893226L, 4062893228L, 4062893241L, 4062893246L),
    List(4062893267L, 4062893280L, 4062893290L, 4062893291L, 4062893293L, 4062893297L, 4062893298L, 4062893299L, 4062893306L, 4062893309L, 4062893319L, 4062893342L, 4062893346L, 4062893352L, 4062893360L, 4062893361L),
    List(4062893369L, 4062893371L, 4062893375L, 4062893392L, 4062893393L, 4062893400L, 4062893403L, 4062893422L, 4062893443L, 4062893449L, 4062893452L, 4062893460L, 4062893478L, 4062893590L, 4062893600L, 4062893608L),
    List(4062893610L, 4062893615L, 4062893622L, 4062893624L, 4062893628L, 4062903180L, 4062903195L, 4062903196L, 4062903200L, 4062903213L, 4062903218L, 4062903219L, 4062903227L, 4062903234L, 4062903245L, 4062903247L),
    List(4063343136L, 4063822882L, 4063822885L, 4063823789L, 4063823809L, 4063823811L, 4063907104L, 4063907105L, 4063907126L, 4063907132L, 4063907142L, 4063907145L, 4063907151L, 4063907157L, 4063907173L, 4063907181L),
    List(4063907602L, 4063907605L, 4063907608L, 4063907620L, 4063907630L, 4063907633L, 4063907644L, 4063907646L, 4063907654L, 4063907660L, 4063907664L, 4063907674L, 4063907675L, 4063907682L, 4063907686L, 4063907692L),
    List(4063907698L, 4063907707L, 4063907727L, 4063907737L, 4063907745L, 4063907747L, 4063907748L, 4063907752L, 4063907757L, 4063907759L, 4063943695L, 4063943702L, 4063943703L, 4063943727L, 4063943734L, 4063943742L),
    List(4063943743L, 4063943747L, 4063943749L, 4063943767L, 4063943775L, 4063943892L, 4063943895L, 4063943897L, 4063943903L, 4063943937L, 4063943949L, 4063943951L, 4063943953L, 4063943957L, 4063943963L, 4063943968L),
    List(4063943986L, 4063944004L, 4063944012L, 4063944032L, 4063944073L, 4063944088L, 4063944105L, 4063944107L, 4063944116L, 4063944122L, 4063944124L, 4063944135L, 4063944141L, 4063944160L, 4063944178L, 4063944180L)
  )

  val moop2: List[List[Long]] = List(
    List(4065869449L, 4065869451L, 4065869454L, 4065869463L, 4065869464L, 4065869476L, 4065869594L, 4065872373L, 4065872381L, 4065897769L, 4065897774L, 4065897781L, 4065897785L, 4065899400L, 4065899401L, 4065900403L),
    List(4065900814L, 4065900816L, 4065900823L, 4065903695L, 4065903696L, 4065928651L, 4065946173L, 4065946180L, 4065946187L, 4065953291L, 4065955253L, 4065955274L, 4065955282L, 4065955286L, 4065957792L, 4065957795L),
    List(4065963938L, 4065963941L, 4065963942L, 4065963948L, 4065963950L, 4065963975L, 4065963981L, 4065968231L, 4065968240L, 4065968242L, 4065968278L, 4065968287L, 4065968499L, 4065968508L, 4065969709L, 4065969711L),
    List(4065969720L, 4065969739L, 4065969745L, 4065970402L, 4065970405L, 4065970413L, 4065973254L, 4065973257L, 4065973259L, 4065973260L, 4065973284L, 4065973838L, 4065973851L, 4065973870L, 4065973884L, 4065973885L),
    List(4065973998L, 4065974000L, 4065974005L, 4065975321L, 4065975335L, 4065975339L, 4065975340L, 4065997716L, 4065997729L, 4066000389L, 4066000395L, 4066000405L, 4066000413L, 4066000414L, 4066000426L, 4066000433L),
    List(4066000449L, 4066066570L, 4066066578L, 4066066580L, 4066066583L, 4066067153L, 4066067189L, 4066067192L, 4066067195L, 4066067196L, 4066067199L, 4066067205L, 4066067216L, 4066098986L, 4066100991L, 4066100994L),
    List(4066101000L, 4066101002L, 4066101008L, 4066101022L, 4066101026L, 4066109942L, 4066109952L, 4066109957L, 4066109959L, 4066109963L, 4066137983L, 4066137987L, 4066138097L, 4066138110L, 4066138120L, 4066138122L),
    List(4066138137L, 4066138151L, 4066138153L, 4066138155L, 4066138159L, 4066138162L, 4066138167L, 4066138169L, 4066138172L, 4066138204L, 4066138213L, 4066138217L, 4066138220L, 4066138227L, 4066138259L, 4066138260L),
    List(4066138265L, 4066138279L, 4066138291L, 4066138321L, 4066138332L, 4066138335L, 4066138336L, 4066138338L, 4066138343L, 4066138345L, 4066138354L, 4066138360L, 4066138362L, 4066138365L, 4066138367L, 4066138371L),
    List(4066138372L, 4066138395L, 4066138406L, 4066142170L, 4066152016L, 4066152026L, 4066152030L, 4066152032L, 4066152048L, 4066152075L, 4066152082L, 4066152084L, 4066152194L, 4066152206L, 4066152212L, 4066152214L),
    List(4066152221L, 4066152228L, 4066152230L, 4066152233L, 4066152237L, 4066152240L, 4066152285L, 4066152288L, 4066152294L, 4066152302L, 4066152305L, 4066152318L, 4066152323L, 4066152337L, 4066152355L, 4066152359L),
    List(4066152365L, 4066152366L, 4066152370L, 4066152388L, 4066152396L, 4066152400L, 4066152402L, 4066152412L, 4066152415L, 4066152418L, 4066152422L, 4066152429L, 4066152435L, 4066152443L, 4066158490L, 4066158496L),
    List(4066158500L, 4066158511L, 4066158514L, 4066158532L, 4066158550L, 4066158551L, 4069250977L, 4070020859L, 4070020876L, 4070020879L, 4070020886L, 4070020887L, 4070020891L, 4070020897L, 4070020904L, 4070020906L),
    List(4070020908L, 4070020911L, 4070020919L, 4070020923L, 4070020926L, 4070020927L, 4070020939L, 4070020948L, 4070020954L, 4070020965L, 4070020994L, 4070021000L, 4070021004L, 4070021009L, 4070021016L, 4070021036L),
    List(4070021047L, 4070021048L, 4070021049L, 4070054233L, 4070054236L, 4070054244L, 4070054261L, 4070054266L, 4070054269L, 4070054279L, 4070061986L, 4070062489L, 4070062495L, 4070062497L, 4070062511L, 4070062515L),
    List(4070062521L, 4070062525L, 4070062527L, 4070062531L, 4070062550L, 4070062563L, 4070062566L, 4070062568L, 4070062569L, 4070062571L, 4070062574L, 4070062592L, 4070062611L, 4070062623L, 4070062624L, 4070062643L),
    List(4070062644L, 4070062647L, 4070062648L, 4070062659L, 4070062660L, 4070062672L, 4070062673L, 4070062689L, 4070062702L, 4070062703L, 4070062711L, 4070062713L, 4070062714L, 4070062719L, 4070062721L, 4070062729L),
    List(4070062751L, 4070064091L, 4070064096L, 4070064116L, 4070077042L, 4070077050L, 4070077051L, 4070077053L, 4070077065L, 4070077075L, 4070077078L, 4070077088L, 4070077189L, 4070077198L, 4070077199L, 4070077200L),
    List(4070077202L, 4070077209L, 4070077212L, 4070077248L, 4070077256L, 4070077267L, 4070077286L, 4070077389L, 4070077392L, 4070077394L, 4070077413L, 4070077450L, 4070077451L, 4070077453L, 4070077457L, 4070077460L),
    List(4070077475L, 4070077482L, 4070077483L, 4070077589L, 4070077590L, 4070077597L, 4070576114L, 4070576121L, 4070590443L, 4071236113L, 4071236116L, 4071310627L, 4071310628L, 4071845119L, 4071845129L, 4071845130L),
    List(4071845135L, 4071845150L, 4071845161L, 4071845174L, 4071845590L, 4071845616L, 4071862348L, 4071862353L, 4071862364L, 4071862371L, 4071862374L, 4071862377L, 4071862388L, 4071862693L, 4071862695L, 4071862698L),
    List(4071862710L, 4071862715L, 4071862718L, 4071862727L, 4071862728L, 4071862733L, 4071862748L, 4071862760L, 4071862763L, 4071862770L, 4071862772L, 4071862773L, 4071862793L, 4071862794L, 4071862800L, 4071862805L),
    List(4071862809L, 4071862810L, 4071862812L, 4071862814L, 4071862830L, 4071880099L, 4071880101L, 4071880124L, 4071880128L, 4071880137L, 4071880140L, 4071880153L, 4071880155L, 4071880164L, 4071880175L, 4071880185L),
    List(4071880187L, 4071880188L, 4071889144L, 4071896615L, 4071896625L, 4071915092L, 4071915104L, 4071915108L, 4071915129L, 4071915134L, 4071915145L, 4071915152L, 4071915153L, 4071915158L, 4071915166L, 4071927956L),
    List(4071927962L, 4071927965L, 4071927976L, 4071927981L, 4071929697L, 4071929704L, 4071929707L, 4072012027L, 4072012068L, 4072012072L, 4072012078L, 4072012084L, 4072012085L, 4072012792L, 4072012804L, 4072012810L),
    List(4072111597L, 4072111601L, 4072111602L, 4072111609L, 4072111614L, 4072111639L, 4072111642L, 4072111643L, 4072111660L, 4072111668L, 4072111675L, 4072111678L, 4072111679L, 4072112017L, 4072112086L, 4072112089L),
    List(4072112096L, 4072112108L, 4072160910L, 4072160925L, 4072160936L, 4072160969L, 4072160971L, 4072160972L, 4072160976L, 4072160979L, 4072161090L, 4072161093L, 4072161096L, 4072161104L, 4072161120L, 4072161126L),
    List(4072161127L, 4072161130L, 4072161131L, 4072161132L, 4072161145L, 4072161149L, 4072161150L, 4072172185L, 4072172290L, 4072172306L, 4072172309L, 4072172314L, 4072172317L, 4072172319L, 4072172320L, 4072172327L),
    List(4072172329L, 4072172339L, 4072172340L, 4072172367L, 4072172368L, 4072172369L, 4072172372L, 4072172375L, 4072172381L, 4072188364L, 4072210443L, 4072210448L, 4072210455L, 4072210468L, 4072210483L, 4072222889L),
    List(4072222897L, 4072222921L, 4072222923L, 4072222932L, 4072222936L, 4072222945L, 4072222947L, 4072222950L, 4072222952L, 4072222960L, 4072222962L, 4072222969L, 4072222971L, 4072222979L, 4072223008L, 4072223014L),
    List(4072223019L, 4072223031L, 4072223039L, 4072223049L, 4072223062L, 4072223069L, 4072223099L, 4072223103L, 4072223105L, 4072223107L, 4072260773L, 4072260782L, 4072260787L, 4072266397L, 4072266398L, 4072266399L),
    List(4072266408L, 4072266410L, 4072266423L, 4072266436L, 4072266442L, 4072266444L, 4072266453L, 4072266455L, 4072266468L, 4072266480L, 4072266495L, 4072266496L, 4072266507L, 4072266532L, 4072266556L, 4072266559L),
    List(4072266562L, 4072266565L, 4072266572L, 4072266579L, 4072266585L, 4072266594L, 4072266604L, 4072266605L, 4072266610L, 4072266628L, 4072266632L, 4072266644L, 4072266648L, 4072266655L, 4072266673L, 4072266681L),
    List(4072266683L, 4072266685L, 4072266796L, 4072266798L, 4072266826L, 4072266846L, 4072266859L, 4072266860L, 4072266881L, 4072266892L, 4072266908L, 4072266912L, 4072266918L, 4072266924L, 4072266932L, 4072266940L),
    List(4072266945L, 4072266946L, 4072266958L, 4072266959L, 4072266960L, 4072266967L, 4072266991L, 4072339941L, 4072379105L, 4072379121L, 4072390845L, 4072501717L, 4072640612L, 4072640619L, 4072640622L, 4072641325L),
    List(4072658601L, 4072658604L, 4072658624L, 4072658627L, 4072658632L, 4072892477L, 4072892483L, 4072896690L, 4072896693L, 4072897687L, 4072898189L, 4072898193L, 4072898197L, 4072899119L, 4072899128L, 4072903354L),
    List(4072903359L, 4072903367L, 4072903374L, 4072903383L, 4072903384L, 4072903386L, 4072903790L, 4072903805L, 4072906655L, 4072906661L, 4072906663L, 4072909118L, 4072909120L, 4072915173L, 4072915179L, 4072916909L),
    List(4072916910L, 4072921909L, 4072921915L, 4072921923L, 4072921927L, 4072921931L, 4072921934L, 4072927198L, 4072927199L, 4072927205L, 4072927207L, 4072927212L, 4072927213L, 4072928644L, 4072932369L, 4072932371L),
    List(4072932380L, 4072932381L, 4072932391L, 4072932396L, 4072932405L, 4072934771L, 4072934775L, 4072934778L, 4072935398L, 4072940053L, 4072940059L, 4072940064L, 4072947794L, 4072947802L, 4072947803L, 4072947811L),
    List(4072947812L, 4072947825L, 4072947838L, 4072947839L, 4072947842L, 4072954228L, 4072954232L, 4072954233L, 4072954236L, 4072987093L, 4073363243L, 4073363256L, 4073363258L, 4073363263L, 4073363273L, 4073363276L),
    List(4073363283L, 4073363285L, 4073363304L, 4073363305L, 4073363306L, 4073363312L, 4073363317L, 4073363318L, 4073472299L, 4073472317L, 4073472318L, 4073472324L, 4073472336L, 4073472347L, 4073472356L, 4073472382L),
    List(4073472383L, 4073488893L, 4073488922L, 4073488942L, 4073488948L, 4073488955L, 4073488957L, 4073488960L, 4073488982L, 4073489090L, 4073489109L, 4073489115L, 4073853656L, 4073853661L, 4073986849L, 4073986871L),
    List(4073986880L, 4073986887L, 4073986907L, 4074155186L, 4074159798L, 4074159804L, 4074159817L, 4074159830L, 4074162895L, 4074164224L, 4074164233L, 4074164449L, 4074164450L, 4074164464L, 4074164476L, 4074164478L),
    List(4074179514L, 4074179522L, 4074179809L, 4074189463L, 4074189465L, 4074189466L, 4074196100L, 4074198161L, 4074212992L, 4074236315L, 4074236332L, 4074238393L, 4074238394L, 4074238400L, 4074238418L, 4074248313L),
    List(4074248314L, 4074248323L, 4074248331L, 4074248339L, 4074248346L, 4074248354L, 4074248357L, 4074248361L, 4074248362L, 4074248385L, 4074248386L, 4074248387L, 4074248501L, 4074248504L, 4074248515L, 4074248520L),
    List(4074248521L, 4074255387L, 4074256566L, 4074256571L, 4074256573L, 4074256575L, 4074256577L, 4074256696L, 4074256698L, 4074256700L, 4074256706L, 4074256718L, 4074260474L, 4074260478L, 4074260589L, 4074260604L),
    List(4074260606L, 4074261816L, 4074261832L, 4074261841L, 4074261845L, 4074261847L, 4074261852L, 4074261857L, 4074269195L, 4074273540L, 4074273543L, 4074273559L, 4074277489L, 4074277497L, 4074715291L, 4074715295L),
    List(4074715296L, 4074715311L, 4074715320L, 4074715321L, 4074715326L, 4074715337L, 4074715338L, 4074715343L, 4074715348L, 4074715353L, 4074715363L, 4074715371L, 4074718689L, 4074718694L, 4074718698L, 4074721904L),
    List(4074721907L, 4074723519L, 4074723526L, 4074723538L, 4074726392L, 4074726401L, 4074726429L, 4074726432L, 4074726438L, 4074727905L, 4074728099L, 4074728106L, 4074728107L, 4074730791L, 4074732723L, 4074732737L),
    List(4074736244L, 4074736254L, 4074736256L, 4074736257L, 4074736258L, 4074738011L, 4074738027L, 4074738033L, 4074738050L, 4074742406L, 4074742414L, 4074742419L, 4074742424L, 4074742433L, 4074742435L, 4074998234L),
    List(4075010258L, 4075010265L, 4075024282L, 4075024285L, 4075024288L, 4075025597L, 4075025598L, 4075033078L, 4075033082L, 4075033690L, 4075033709L, 4075033714L, 4075039612L, 4075039617L, 4075041685L, 4075042289L),
    List(4075042728L, 4075042735L, 4075042739L, 4075042744L, 4075050471L, 4075052604L, 4075052616L, 4075055402L, 4075055410L, 4075055424L, 4075055425L, 4075055429L, 4075070862L, 4075070870L, 4075079101L, 4075079114L),
    List(4075079124L, 4075370237L, 4075377828L, 4075377849L, 4075377854L, 4075377859L, 4075377862L, 4075480378L, 4075480379L, 4075480384L, 4075482601L, 4075482602L, 4075493968L, 4075517877L, 4075517882L, 4075517888L),
    List(4075520295L, 4075520298L, 4075520314L, 4075520316L, 4075520325L, 4075520331L, 4075520338L, 4075520340L, 4075520367L, 4075532397L, 4075532399L, 4075532403L, 4075532406L, 4075532413L, 4075532422L, 4075532427L),
    List(4075543393L, 4075543398L, 4075543423L, 4075543430L, 4075543441L, 4075543449L, 4075543453L, 4075551952L, 4075551953L, 4075552503L, 4075552513L, 4075552525L, 4075552538L, 4075552539L, 4075552544L, 4075552551L),
    List(4075552555L, 4075552556L, 4075552559L, 4075552566L, 4075552583L, 4075552694L, 4075560105L, 4075560109L, 4075560130L, 4075569182L, 4075569186L, 4075569188L, 4075569589L, 4075569614L, 4075569616L, 4075569619L)
  )

  val moop3: List[Long] = List(4040837174L, 4040837176L, 4040837181L)

  // private def recurseNode(nodeId: Long) = {
  //   var keepGoing = true
  //   val relations = mutable.Set.empty[Long]

  //   val ways = nodeToWays
  //     .filter(col("id") === nodeId)
  //     .map({ r => r.getAs[Long]("way_id") })
  //     .collect
  //     .toSet

  //   relations ++=
  //   (if (ways.isEmpty)
  //     Set.empty[Long]
  //   else {
  //     wayToRelations
  //       .filter(col("id").isin(ways.toSeq:_*))
  //       .map({ r => r.getAs[Long]("relation_id") })
  //       .collect
  //       .toSet
  //   })

  //   while (keepGoing) {
  //     keepGoing = false
  //     val newRelations =
  //       if (relations.isEmpty) Set.empty[Long]
  //       else {
  //         relationToRelations
  //           .filter(col("id").isin(relations.toSeq:_*))
  //           .map({ r => r.getAs[Long]("relation_id") })
  //           .collect
  //           .toSet
  //       }
  //     if (!newRelations.subsetOf(relations)) {
  //       keepGoing = true
  //       relations ++= newRelations
  //     }
  //   }

  //   (ways, relations)
  // }

  def main(args: Array[String]): Unit = {

    Logger.getLogger("org").setLevel(Level.ERROR)
    Logger.getLogger("akka").setLevel(Level.ERROR)

    if (args(0) != "xxx") {
      val cr = new XmlChangeReader(new File(args(0)), true, CompressionMethod.None)
      val ca = new ChangeAugmenter(spark)
      cr.setChangeSink(ca)
      cr.run
    }
    else {
      if (args.length > 1 && args(1) == "xxx")
        spark.table("osm").union(spark.table("osm_updates")).count
      val time1 = System.currentTimeMillis
      val (ways1, relations1) = recurseNodes(moop2.flatMap(identity))
      val time2 = System.currentTimeMillis
      val (ways2, relations2) = recurseNodes(moop1.flatMap(identity))
      val time3 = System.currentTimeMillis
      val (ways3, relations3) = recurseNodes(moop3)
      val time4 = System.currentTimeMillis
      println(s"${ways1.size} ${relations1.size} ${ways2.size} ${relations2.size}")
      println(s"${time2 - time1} ${time3 - time2} ${time4 - time3}")
    }
  }

}
